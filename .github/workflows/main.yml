name: cloud_infra_workflow

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  # S3_Creation:
  #   runs-on: self-hosted
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v3
  #     - name: terraform initialization
  #       uses: hashicorp/setup-terraform@v2
  #     - name: Create S3 bucket for terraform state
  #       run: |
  #         terraform init
  #         terraform apply -auto-approve -target=aws_iam_role.sam_ec2_role_2
  #         terraform apply -auto-approve -target=aws_iam_role_policy_attachment.sam_ec2_policy_attachment
  #         terraform apply -auto-approve -target=aws_iam_instance_profile.sam_ec2_instance_profile_1
  #         terraform apply -auto-approve -target=aws_s3_bucket.tf_state
  #         terraform apply -auto-approve -target=aws_s3_bucket_versioning.tf_state_versioning
  #         terraform apply -auto-approve -target=aws_s3_bucket_server_side_encryption_configuration.tf_state_encryption

  build:
    runs-on: self-hosted
    #needs: S3_Creation
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Terraform Init
        run: terraform init -migrate-state -force-copy
      # - name: backedn setup
      #   run: terraform init --backend-config="bucket=tf_state_backup" --backend-config="key=terraform.tfstate" --backend-config="region=ap-south-1" 

  test:
    runs-on: self-hosted
    needs: build
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2

      - name: Setup Node.js
        uses: actions/setup-node@v4

      - name: Terraform Init
        run: terraform init -migrate-state -force-copy

      - name: Terraform Plan
        run: terraform plan
      # - name: backedn setup
      #   run: terraform init --backend-config="bucket=tf_state_backup" --backend-config="key=terraform.tfstate" --backend-config="region=ap-south-1"

  deploy:
    runs-on: self-hosted
    needs: test
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2

      - name: Setup Node.js
        uses: actions/setup-node@v4

      - name: Terraform Init
        run: terraform init -migrate-state -force-copy

      - name: Terraform Apply
        if: github.ref == 'refs/heads/main'
        run: terraform apply -auto-approve
      # - name: backedn setup
      #   run: terraform init --backend-config="bucket=tf_state_backup" --backend-config="key=terraform.tfstate" --backend-config="region=ap-south-1"

  

      - name: Get Terraform outputs
        id: tf
        run: |
          {
           echo "INSTANCE_ID<<EOF"
          terraform output -raw app_instance_id
          echo "EOF"

          echo "PUBLIC_IP<<EOF"
          terraform output -raw app_instance_public_ip
          echo "EOF"

          echo "AZ<<EOF"
          terraform output -raw app_instance_az
          echo "EOF"
          } >> $GITHUB_ENV


      - name: Run postTerraformscript
        run: bash postTerraformscript.sh
        env:
          INSTANCE_ID: ${{ env.INSTANCE_ID }}
          PUBLIC_IP: ${{ env.PUBLIC_IP }}
          AZ: ${{ env.AZ }}
